<?php

/**
 * @file
 * Code for the eReolen base module feature.
 */

include_once 'reol_base.features.inc';

module_load_include('inc', 'reol_base', 'reol_base.field');

define('REOL_BASE_LOCAL_ID_PREFIX', 'isbn_');

/**
 * Get the field form for a field.
 *
 * @param string $type
 *   The entity type to get field for.
 * @param string $bundle
 *   The entity bundle for the entity.
 * @param string $field_name
 *   The name of the field.
 * @param object $entity
 *   The entity to get field for.
 * @param array $form
 *   The form to attach field to.
 * @param array $form_state
 *   The state of the form.
 *
 * @return array
 *   The field form.
 */
function reol_base_get_field_form($type, $bundle, $field_name, $entity, array &$form, array &$form_state) {
  $field = field_info_field($field_name);
  $instance = field_info_instance($type, $field_name, $bundle);
  $lang_code = field_language($type, $entity, $field_name);
  $items = field_get_items($type, $entity, $field_name);
  return field_default_form($type, $entity, $field, $instance, $lang_code, $items, $form, $form_state);
}

/**
 * Implements hook_menu().
 */
function reol_base_menu() {
  $items = array();

  $items['login/nojs'] = array(
    'title' => 'Login',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('user_login'),
    'access callback' => 'user_is_anonymous',
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'main-menu',
  );

  $items['login/ajax'] = array(
    'page callback' => 'reol_base_login_ajax',
    'delivery callback' => 'ajax_deliver',
    // Access set to true as the popup re-triggers the login link on
    // successful login, which call this page again. reol_base_login_ajax will
    // redirect user if already logged in.
    'access callback' => TRUE,
  );

  $items['user/%user/logout'] = array(
    'title' => 'Log out',
    'page callback' => 'reol_base_logout',
    'access callback' => 'user_is_logged_in',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1000,
  );

  // Configuration page block.
  $items['admin/config/ereolen'] = array(
    'title' => 'eReolen',
    'description' => 'eReolen settings.',
    'position' => 'right',
    'weight' => 20,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer site configuration'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  return $items;
}

/**
 * Implements hook_preprocess_HOOK() for menu_link().
 *
 * Add use-ajax class to our login link.
 */
function reol_base_preprocess_menu_link(&$variables) {
  $element = &$variables['element'];
  if (isset($element['#original_link']) && $element['#original_link']['router_path'] == 'login/nojs') {
    $element['#localized_options']['attributes']['class'][] = 'use-ajax';
  }
}

/**
 * Implements hook_entity_info_alter().
 */
function reol_base_entity_info_alter(&$entity_info) {
  // The compact view mode fits into the carousel.
  $entity_info['ting_object']['view modes']['compact'] = array(
    'label' => t('Compact'),
    'custom settings' => TRUE,
  );
}

/**
 * Implements hook_menu_alter().
 */
function reol_base_menu_alter(&$items) {
  $items['user']['access callback'] = 'user_is_logged_in';

  // Remove menu callback from user menu.
  $items['user/%user/status']['access callback'] = FALSE;
  $items['user/%user/status-debts']['access callback'] = FALSE;
  $items['user/%user/status-loans']['access callback'] = FALSE;
  $items['user/%user/status-loans-overdue']['access callback'] = FALSE;
  $items['user/%user/my-library']['access callback'] = FALSE;
  $items['user/%user/status-reservations']['access callback'] = FALSE;
  $items['user/%user/status']['access callback'] = FALSE;
  $items['user/%user/status-reservations-ready']['access callback'] = FALSE;

  // Disable informedia and full text.
  $items['ting/infomedia/%infomedia']['access callback'] = FALSE;
  $items['ting/object/infomedia/%']['access callback'] = FALSE;

  // Change title of user menu.
  $items['user/%user/view']['title'] = "Loans and reservations";
}

/**
 * Implements hook_ding_user_frontend_build_menu_alter().
 */
function reol_base_ding_user_frontend_build_menu_alter(&$menu) {
  $menu['user/%user/bookmarks']['#weight'] = -5;
  $menu['user/%user/edit']['#weight'] = 0;
}

/**
 * Implements hook_init().
 *
 * Add drupal.ajax to every page for login popup. As the login is a menu item,
 * we can't attach it to the link itself, and hook_page_alter() doesn't
 * seem to work.
 */
function reol_base_init() {
  drupal_add_library('system', 'drupal.ajax', TRUE);
}

/**
 * Implements hook_form_alter().
 */
function reol_base_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'user_login':
    case 'user_login_block':
      // Remove into text from DDB core.
      if (!empty($form['intro_text'])) {
        unset($form['intro_text']);
      }

      // Change the login fields.
      unset($form['user_login_container']['name']['#attributes']['placeholder']);
      $form['user_login_container']['name']['#title_display'] = 'before';
      unset($form['user_login_container']['pass']['#attributes']['placeholder']);
      $form['user_login_container']['pass']['#title_display'] = 'before';
      break;

    case 'ding_loan_loans_form':
    case 'ding_reservation_reservations_notready_form':
      $form['actions_container']['#access'] = FALSE;
      break;
  }
}

/**
 * Implements hook_strongarm_import_value_alter().
 */
function reol_base_strongarm_import_value_alter(&$value, $name) {
  if ('media_wysiwyg_default_render' == $name) {
    $value = 'field_attach';
  }
}

/**
 * Implements hook_image_default_styles().
 *
 * Re-adds image styles used by old campaign module and now used by the front
 * page carousel.
 */
function reol_base_image_default_styles() {
  $styles = array();

  // Exported image style: ding_campaign_p_100.
  $styles['ding_campaign_p_100'] = array(
    'name' => 'ding_campaign_p_100',
    'label' => 'Campaign (100% - 1200px)',
    'effects' => array(
      7 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 1200,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_p_25.
  $styles['ding_campaign_p_25'] = array(
    'name' => 'ding_campaign_p_25',
    'label' => 'Campaign (25% - 280px)',
    'effects' => array(
      1 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 280,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_p_33.
  $styles['ding_campaign_p_33'] = array(
    'name' => 'ding_campaign_p_33',
    'label' => 'Campaign (33% - 380px)',
    'effects' => array(
      3 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 380,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_p_50.
  $styles['ding_campaign_p_50'] = array(
    'name' => 'ding_campaign_p_50',
    'label' => 'Campaign (50% - 580px)',
    'effects' => array(
      4 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 580,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_p_66.
  $styles['ding_campaign_p_66'] = array(
    'name' => 'ding_campaign_p_66',
    'label' => 'Campaign (66% - 780px)',
    'effects' => array(
      5 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 780,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_p_75.
  $styles['ding_campaign_p_75'] = array(
    'name' => 'ding_campaign_p_75',
    'label' => 'Campaign (75% - 880px)',
    'effects' => array(
      6 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 880,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
  );

  // Exported image style: ding_campaign_w_180.
  $styles['ding_campaign_w_180'] = array(
    'name' => 'ding_campaign_w_180',
    'effects' => array(
      3 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 180,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
    'label' => 'ding_campaign_w_180',
  );

  // Exported image style: ding_campaign_w_280.
  $styles['ding_campaign_w_280'] = array(
    'name' => 'ding_campaign_w_280',
    'effects' => array(
      4 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 280,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
    'label' => 'ding_campaign_w_280',
  );

  // Exported image style: ding_campaign_w_380.
  $styles['ding_campaign_w_380'] = array(
    'name' => 'ding_campaign_w_380',
    'effects' => array(
      5 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 380,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
    'label' => 'ding_campaign_w_380',
  );

  // Exported image style: ding_campaign_w_480.
  $styles['ding_campaign_w_480'] = array(
    'name' => 'ding_campaign_w_480',
    'effects' => array(
      6 => array(
        'label' => 'Scale',
        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
        'effect callback' => 'image_scale_effect',
        'dimensions callback' => 'image_scale_dimensions',
        'form callback' => 'image_scale_form',
        'summary theme' => 'image_scale_summary',
        'module' => 'image',
        'name' => 'image_scale',
        'data' => array(
          'width' => 480,
          'height' => '',
          'upscale' => 1,
        ),
        'weight' => 1,
      ),
    ),
    'label' => 'ding_campaign_w_480',
  );

  return $styles;
}

/**
 * Implements hook_entity_load().
 *
 * As our provider uses ISBN-numbers, we wish to have localId be the
 * ISBN-number of the object.
 */
function reol_base_entity_load($entities, $type) {
  // Only act on our own type.
  if ($type != 'ting_object') {
    return;
  }

  $local_id = NULL;
  foreach ($entities as $entity) {
    $entity->online_url = FALSE;

    if (!($entity instanceof TingEntity)) {
      continue;
    }
    // Provide a 'isbn_' local id if the ding_entity_id matches our own fake ID.
    if (isset($entity->ding_entity_id) && $isbn = reol_base_fake_id($entity->ding_entity_id)) {
      $local_id = 'isbn_' . $isbn;

      // As this is a fake entity, will try to get the title from publizon.
      $product = publizon_load($local_id);
      if ($product) {
        $entity->reply->openSearchObject->record['dc:title'][""][0] = $product->title;
      }
    }
    // When have to check all the way down, as chain might be broken
    // somewhere. Only touch localId if we have the right value for it.
    elseif (isset($entity->reply) &&
      isset($entity->reply->record) &&
      isset($entity->reply->record['dc:identifier'])) {
      $local_id = FALSE;

      // Try to find the id we need in oss:PROVIDER-ID.
      if (isset($entity->reply->record['dc:identifier']['oss:PROVIDER-ID']) && count($entity->reply->record['dc:identifier']['oss:PROVIDER-ID']) == 1) {
        $local_id = reol_base_get_local_id($entity->reply->record['dc:identifier']['oss:PROVIDER-ID']);
      }
      // If not found there, look in dkdcplus:ISBN.
      elseif (isset($entity->reply->record['dc:identifier']['dkdcplus:ISBN']) && count($entity->reply->record['dc:identifier']['dkdcplus:ISBN'])) {
        $local_id = reol_base_get_local_id($entity->reply->record['dc:identifier']['dkdcplus:ISBN']);
      }

    }
    if ($local_id) {
      $entity->localId = $local_id;
    }
  }
}

/**
 * Implements hook_wysiwyg_default_profiles_alter().
 *
 * Override WYSIWYG profile to be more limited.
 */
function reol_base_wysiwyg_default_profiles_alter(&$profiles) {
  if (isset($profiles['ding_wysiwyg'])) {
    // Append custom theme css to wysiwyg editor.
    // The default styles.
    $css_paths = ['profiles/ding2/libraries/ckeditor/contents.css'];
    $themes = list_themes();
    // Add styles from installed theme and its base theme (“pratchett”).
    foreach (['pratchett', 'orwell', 'wille'] as $theme_name) {
      if (isset($themes[$theme_name]) &&
        ('pratchett' === $theme_name || 1 === $themes[$theme_name]->status)) {
        $css_path = drupal_get_path('theme', $theme_name) . '/ckeditor/contents.css';
        if (file_exists($css_path)) {
          $css_paths[] = $css_path;
        }
      }
    }
    $profiles['ding_wysiwyg']['settings']['css_path'] = implode(',', $css_paths);

    // Limit block elements to the ones we style.
    $profiles['ding_wysiwyg']['settings']['block_formats'] = 'p,h3,h4';

    // Remove buttons to eliminate the amount of damage an editor can inflict.
    $profiles['ding_wysiwyg']['settings']['buttons']['default'] = array(
      'Format' => 1,
      'Bold' => 1,
      'Italic' => 1,
      'BulletedList' => 1,
      'Link' => 1,
      'Unlink' => 1,
      'PasteFromWord' => 1,
      'ShowBlocks' => 1,
      'RemoveFormat' => 1,
    );
  }
}

/**
 * Implements hook_filter_default_formats().
 *
 * Limit the elements allowed in WYSIWYG format.
 */
function reol_base_filter_default_formats_alter(&$formats) {
  if (isset($formats['ding_wysiwyg'])) {
    $formats['ding_wysiwyg']['filters']['filter_html']['settings']['allowed_html'] = '<a> <p> <em> <strong> <ul> <li> <br> <img> <h2> <h3> <h4> <h5> <h6>';
  }
}

/**
 * Convert an array of ISBN-numbers to a local id.
 *
 * @param mixed $isbns
 *   The ISBN number array to convert.
 *
 * @return string
 *   The localId string.
 */
function reol_base_get_local_id($isbns) {
  // Make sure it is an array.
  if (!is_array($isbns)) {
    $isbns = array($isbns);
  }

  $num = FALSE;
  foreach ($isbns as $isbn) {
    $isbn = str_replace('-', '', $isbn);
    // ISBN is the first 13-length number found.
    if (strlen($isbn) == 13) {
      $num = $isbn;
      break;
    }
  }

  // We have no ISBN-number to use.
  if (!$num) {
    return FALSE;
  }

  // Add our prefix and remove dashes that might appear.
  // We add the prefix to avoid strange conflicts with entities
  // that have their local id defined as the ISBN-number.
  return REOL_BASE_LOCAL_ID_PREFIX . $num;
}

/**
 * Convert the local id to an ISBN number.
 *
 * @param string $local_id
 *   The local id.
 *
 * @return string
 *   The ISBN number.
 */
function reol_base_get_isbn($local_id) {
  // Remove prefix in front, if found.
  // If not, it is not an ISBN-number.
  if (strpos($local_id, REOL_BASE_LOCAL_ID_PREFIX) === 0) {
    return substr($local_id, strlen(REOL_BASE_LOCAL_ID_PREFIX));
  }

  return FALSE;
}

/**
 * Implements hook_theme_registry_alter().
 *
 * Change material_item to use our template instead.
 * Change default image theme function.
 */
function reol_base_theme_registry_alter(&$theme_registry) {
  $theme_registry['material_item']['template'] = drupal_get_path('module', 'reol_base') . '/templates/material_item';
}

/**
 * Implements hook_preprocess_material_item().
 */
function reol_base_preprocess_material_item(&$variables) {
  $element = $variables['element'];

  // Entity might be #loan, #reservation or not set.
  if (isset($element['#loan'])) {
    $entity = $element['#loan'];
  }
  elseif (isset($element['#reservation'])) {
    $entity = $element['#reservation'];
  }
  else {
    // If loan or reservation is not set, do nothing.
    return;
  }
  $ding_entity_id = $entity->ding_entity_id;
  $ting_entity = ding_entity_load($ding_entity_id);

  if (reol_base_fake_id($ding_entity_id)) {
    // Material not found in the well, fake it, we need it to call
    // ding_entity_buttons. In retrospect, ding_entity_buttons isn't such a
    // good fit as we've discovered we need to handle loans/reservations
    // that's been deleted in the well, but that's how it is.
    $ting_entity = ding_provider_get_pseudo_entity($entity->ding_entity_id);
    $ting_entity->type = FALSE;
    $ting_entity->localId = REOL_BASE_LOCAL_ID_PREFIX . $ting_entity->tid;
  }

  // Make a note of the loan type if it's one of our fake IDs.
  // reol_use_loan_ding_entity_buttons will use this.
  if (reol_base_fake_id($ding_entity_id)) {
    $ting_entity->publizon_type = $entity->publizon_type;
  }

  // The entity may not exists and ding_entity_buttons will assume that it
  // exists.
  $buttons = module_invoke_all('ding_entity_buttons', '', $ting_entity, 'default');
  $variables['buttons'] = drupal_render($buttons);
}

/**
 * Implements hook_date_format_Types().
 */
function reol_base_date_format_types() {
  return array(
    'reol_base_material_lists_date' => t('Reol material lists date'),
  );
}

/**
 * Implements hook_date_formats().
 */
function reol_base_date_formats() {
  return array(
    array(
      'type' => 'reol_base_material_lists_date',
      'format' => 'j. F Y H:i:s',
      'locales' => array(),
    ),
  );
}

/**
 * Convert a string to an ISBN-13 number.
 *
 * @param string $isbn
 *   The isbn-number to convert.
 *
 * @return string|bool
 *   The ISBN-numer if input is an ISBN-13 number. False otherwise.
 */
function reol_base_convert_to_isbn($isbn) {
  $isbn = str_replace(array(' ', '-'), '', $isbn);
  return preg_match('/^[0-9]{13}$/', $isbn) ? $isbn : FALSE;
}

/**
 * Get definition of types we support.
 *
 * @return array
 *   Array of types keyed by our internal name. Containing the following info:
 *   - ext_name: Datawell type.
 *   - int_name: Our identifier for this type.
 *   - title: Human readable title.
 *   - title_plural: Human readable title, plural.
 *   - path: Path of main page (possibly obsoleted).
 *   - publizon_formats: The publizon formats used by this type.
 */
function _reol_base_get_types() {
  $types = &drupal_static(__FUNCTION__, array());

  if (empty($types)) {
    $base_types = array(
      'audiobook' => array(
        'ext_name' => 'lydbog (net)',
        'int_name' => 'audiobook',
        'title' => t('Audiobook'),
        'title_plural' => t('Audiobooks'),
        'path' => 'lydboeger',
        // 0 format is a bug in publizon, we assume they must be audiobooks. Ref
        // REOL-253.
        'publizon_formats' => array(0, 71),
        'icon' => 'audiobook',
      ),
      'ebook' => array(
        'ext_name' => 'ebog',
        'int_name' => 'ebook',
        'title' => t('E-book'),
        'title_plural' => t('E-books'),
        'path' => 'eboeger',
        'publizon_formats' => array(50, 58),
        'icon' => 'ebook',
      ),
      'podcast' => array(
        'ext_name' => 'lyd (podcast)',
        'int_name' => 'podcast',
        'title' => t('Podcast'),
        'title_plural' => t('Podcasts'),
        'path' => 'podcasts',
        'publizon_formats' => array(0, 71),
        'icon' => 'podcast',
      ),
    );

    // Subtypes 'extends' the base classes.
    $sub_types = array(
      'epicturebook' => array(
        'base' => 'ebook',
        'ext_name' => 'billedbog (net)',
      ),
      'online comic' => array(
        'base' => 'ebook',
        'ext_name' => 'tegneserie (net)',
      ),
      'online graphic novel' => array(
        'base' => 'ebook',
        'ext_name' => 'graphic novel (net)',
      ),
      'online music' => array(
        'base' => 'audiobook',
        'ext_name' => 'musik (net)',
      ),
      'online yearbook' => array(
        'base' => 'ebook',
        'ext_name' => 'årbog (net)',
      ),
      'online book' => array(
        'base' => 'ebook',
        'ext_name' => 'bog',
      ),
      'online sheet music' => array(
        'base' => 'ebook',
        'ext_name' => 'e-node',
      ),
      'online audiobook' => array(
        'base' => 'audiobook',
        'ext_name' => 'lyd (net)',
      ),
    );

    $types = $base_types;
    foreach ($sub_types as $sub_type => $type) {
      // Clone base type.
      $types[$sub_type] = $base_types[$type['base']];
      unset($type['base']);

      foreach ($type as $name => $value) {
        $types[$sub_type][$name] = $value;
      }
    }
  }

  return $types;
}

/**
 * Return types indexed by property.
 */
function reol_base_get_types_by($key) {
  // Reverse array so the first types will overwrite the latter in case of
  // shared key values.
  $types = array_reverse(_reol_base_get_types());
  $filtered = array_reduce($types, function ($carry, $elem) use ($key) {
    $carry[$elem[$key]] = $elem;
    return $carry;
  }, array());

  // Reverse again.
  return array_reverse($filtered);
}

/**
 * Return type by property.
 */
function reol_base_get_type_by($key, $value) {
  $types = reol_base_get_types_by($key);
  return isset($types['value']) ? $types['value'] : FALSE;
}

/**
 * Get the name of a type from the type returned from Ting.
 *
 * @param string $type
 *   The string type from Ting.
 *
 * @return string
 *   Our own name for the type.
 */
function reol_base_get_type_name($type) {
  $type = reol_base_get_type($type);
  return isset($type['int_name']) ? $type['int_name'] : FALSE;
}

/**
 * Get the definition of a type from the type returned from Ting.
 *
 * If type is not input, it returns an array of names of
 * types we support.
 *
 * @param string $type
 *   The string type from Ting or FALSE/empty to return all.
 *
 * @return mixed
 *   Type definition.
 */
function reol_base_get_type($type = FALSE) {
  $types = _reol_base_get_types();

  // If no argument received, return all types.
  if (!$type) {
    return $types;
  }

  // Find type.
  foreach ($types as $t) {
    if ($t['ext_name'] == drupal_strtolower($type)) {
      return $t;
    }
  }

  // If we end up here, type not found.
  return FALSE;
}

/**
 * Get the icon name for a ting type.
 *
 * @param string $type
 *   The string type from Ting.
 *
 * @return string
 *   Our icon name.
 */
function reol_base_get_type_icon($type) {
  $type = reol_base_get_type($type);
  return isset($type['icon']) ? $type['icon'] : FALSE;
}

/**
 * Get the type class for the type.
 *
 * 'audiobook' or 'ebook'.
 *
 * @param string $type
 *   The string type from Ting.
 *
 * @return string
 *   The type class.
 */
function reol_base_get_type_class($type) {
  $type = reol_base_get_type($type);
  // Currently the class maps to the int_name (all sub-types has a base type
  // int_name).
  return isset($type['int_name']) ? $type['int_name'] : FALSE;
}

/**
 * Get array of types you can choose from in field_reol_entity_type.
 *
 * @return array
 *   Array of types to choose from.
 */
function reol_base_get_entity_types() {
  return array_reduce(reol_base_get_types_by('int_name'), function ($carry, $elem) {
    $carry[$elem['int_name']] = $elem['title'];
    return $carry;
  }, array());
}

/**
 * Get the ting type for a machine name.
 *
 * @param string $machine_name
 *   The machine name to get ting type for.
 *
 * @return string
 *   The ting type for the machine name or FALSE if not found.
 */
function reol_base_get_ting_type($machine_name) {
  $types = _reol_base_get_types();
  return isset($types[$machine_name]) ? $types[$machine_name]['ext_name'] : FALSE;
}

/**
 * Return the internal type for a given Publizon format.
 */
function reol_base_get_type_from_format($format) {
  foreach (_reol_base_get_types() as $type => $spec) {
    if (in_array($format, $spec['publizon_formats'])) {
      return $type;
    }
  }
  return '';
}

/**
 * Implements hook_field_widget_form_alter().
 */
function reol_base_field_widget_form_alter(&$element, &$form_state, $context) {
  if (isset($element['#field_name']) && $element['#field_name'] == 'field_reol_entity_type') {
    // By default, selecting no type means all types. Change label.
    $element['#options']['_none'] = t('- All -');
  }
}

/**
 * Get ding entity ids from multiple ISBN numbers.
 *
 * Searches the well 50 isbn numbers at a time. Limited to 50 to not break the
 * well.
 *
 * @param array $isbns
 *   The ISBN numbers to search for.
 *
 * @return array
 *   isbn => ding entity ids array.
 */
function reol_base_ding_entity_get_ids(array $isbns) {
  // Use static cache to speed up the mapping.
  $mappings = &drupal_static(__FUNCTION__, array());
  $cid = md5(serialize($isbns));

  if (!isset($mappings[$cid])) {
    // Get the id from a search in Ting.
    $chunks = array_chunk($isbns, 50);
    $mapping = array();
    foreach ($chunks as $isbn_chunk) {
      $results = ting_start_query()
        ->withFullTextQuery('ib any "' . implode(" ", $isbn_chunk) . '"')
        ->withCount(50)
        ->withPage(1)
        ->withFacets(array('facet.type'))
        ->withTermsPrFacet(1)
        ->execute();

      if ($results->getNumCollections() > 0) {
        $collections = $results->openSearchResult->collections;
        foreach ($collections as $collection) {
          foreach ($collection->getEntities() as $entity) {
            foreach ($entity->getIsbn() as $isbn) {
              $mapping[$isbn] = $entity->getId();
            }
          }
        }
      }
    }

    $mappings[$cid] = $mapping;
  }

  return $mappings[$cid];
}

/**
 * Remove a node type, that was previously supplied from a feature.
 *
 * Mainly used in .install file, but left here for convenience.
 *
 * @param string $type
 *   The machine name of the type to remove.
 */
function _reol_base_remove_node_type($type) {
  db_update('node_type')
    ->fields(
      array(
        'module' => 'node',
        'custom' => 1,
        'modified' => 1,
        'locked' => 0,
      )
    )
    ->condition('type', $type)
    ->execute();
  node_type_delete($type);
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function reol_base_ctools_plugin_directory($owner, $plugin_type) {
  return 'plugins/' . $plugin_type;
}

/**
 * Ajax callback for logging in.
 */
function reol_base_login_ajax() {
  $commands = array();

  ctools_add_js('ajax-responder');

  // Check if the logged in user is a library user.
  if (!user_is_logged_in()) {
    $commands[] = ajax_command_ding_user_authenticate('');
  }
  else {
    module_load_include('inc', 'ctools', 'includes/ajax');
    $commands[] = ctools_ajax_command_redirect('user');
  }

  return array('#type' => 'ajax', '#commands' => $commands);
}

/**
 * Check entity ajax form.
 *
 * Check that all the prerequisites are fulfilled for
 * showing a popup form in ajax for loaning, reserving or
 * bookmarking entities.
 *
 * @param string $modal_id
 *   The id of the modal.
 * @param array $commands
 *   The commands that should be added to.
 * @param object $entity
 *   The entity.
 *
 * @return bool
 *   Whether or not check did go through.
 */
function reol_base_check_entity_ajax_form($modal_id, array &$commands, $entity) {
  global $user;

  // If user is not logged in, fail.
  if (!user_is_logged_in()) {
    $commands[] = ajax_command_ding_user_authenticate('');
    return FALSE;
  }

  $close = reol_base_get_modal_close_button(t('OK'), $modal_id);
  // If user is not a provider user, fail.
  if (!ding_user_is_provider_user($user)) {
    // Error not library user.
    $commands[] = ajax_command_ding_popup($modal_id, t('Error'), '<p>' . t('Only library user can make reservations.') . '</p>' . $close);
    return FALSE;
  }

  // If entity is not a TingEntity, fail.
  if (!(is_object($entity) && $entity instanceof TingEntity)) {
    $commands[] = ajax_command_ding_popup($modal_id, t('Error'), '<p>' . t('Unable to load information about the material.') . '</p>' . $close);
    return FALSE;
  }

  // Success.
  return TRUE;
}

/**
 * Callback for ajax forms handling loans, reservations or bookmarks.
 *
 * @param string $popup_id
 *   The ID of the ding popup.
 * @param callable $callback
 *   The callback containing the functionality.
 * @param object $entity
 *   The entity.
 *
 * @return array
 *   ajax render array for ajax_deliver.
 */
function reol_base_entity_ajax_form($popup_id, callable $callback, $entity) {
  $args = func_get_args();
  array_shift($args);
  array_shift($args);

  $commands = array();

  // Check validity of everything.
  $valid = reol_base_check_entity_ajax_form($popup_id, $commands, $entity);
  // If valid, run callback.
  if ($valid) {
    try {
      $commands += call_user_func_array($callback, $args);
    }
    catch (DingProviderAuthException $exception) {
      // Authenticate and rerun.
      $commands[] = ajax_command_ding_user_authenticate('');
    }
    catch (DingPublizonException $exception) {
      // Some error occurred, show it.
      $html = $exception->getMessageT(array());
      // If we should show bookmark button.
      if ($exception->showBookmark()) {
        $html .= render(reol_bookmark_get_bookmark_button($entity));
      }
      // If we should show reserve button.
      if ($exception->showReserve()) {
        $html .= render(reol_reservation_get_reserve_button($entity));
      }

      $html .= reol_base_get_modal_close_button(t('OK'), $popup_id);
      $commands[] = ajax_command_ding_popup($popup_id, t('Error'), $html, array('refresh' => TRUE));
    }
    catch (DingProviderEnduserException $exception) {
      // Some error occurred, show it.
      $commands[] = ajax_command_ding_popup($popup_id, t('Error'), '<p>' . $exception->getMessageT(array()) . '</p>', array('refresh' => TRUE));
    }
  }

  // Return the ajax commands as an render array.
  return array('#type' => 'ajax', '#commands' => $commands);
}

/**
 * Get entity button.
 *
 * @param string $text
 *   The text for the button.
 * @param string $link
 *   The link for the button.
 * @param string $id
 *   The id of the button.
 *
 * @return array
 *   Themable button array.
 */
function reol_base_get_entity_button($text, $link, $id, $classes = array()) {
  return array(
    '#theme' => 'link',
    '#text' => $text,
    '#path' => $link,
    '#options' => array(
      'attributes' => array(
        'class' => array_merge(array(
          'action-button',
        ), $classes),
        'id' => $id,
      ),
      'html' => FALSE,
    ),
  );
}

/**
 * Logout.
 */
function reol_base_logout() {
  module_load_include('inc', 'user', 'user.pages');
  user_logout();
}

/**
 * Get the close button for a modal.
 *
 * @param string $text
 *   The text for the button.
 * @param string $modal
 *   The name of the modal to close.
 *
 * @return string
 *   HTML for the button.
 */
function reol_base_get_modal_close_button($text, $modal) {
  drupal_add_js(drupal_get_path('module', 'reol_base') . '/js/reol_base.js');
  return '<a class="action-button modal-close" data-modal-name="' . $modal . '" href="#">' . $text . '</a>';
}

/**
 * Implements hook_cron().
 */
function reol_base_cron() {
  // Rebuild permissions on cron.
  secure_permissions_rebuild();

  // Assign all available permissions to the administrator role. User module
  // only does this on module install, so we do it generally here.
  $rid = variable_get('user_admin_role', 0);
  if ($rid) {
    $permissions = module_invoke_all('permission');
    if (!empty($permissions)) {
      user_role_grant_permissions($rid, array_keys($permissions));
    }
  }

}

/**
 * Implements hook_secure_permissions().
 */
function reol_base_secure_permissions($role) {
  $permissions = array(
    'staff' => array(
      'access administration pages',
      'access all webform results',
      'access content',
      'access content overview',
      'access media browser',
      'access overlay',
      'access own webform results',
      'access own webform submissions',
      'access site in maintenance mode',
      'access site reports',
      'access toolbar',
      'access user profiles',
      'add media from remote sources',
      'administer announcement',
      'administer url aliases',
      'clone node',
      'clone own nodes',
      'create article content',
      'create author_portrait content',
      'create ding_page content',
      'create faq content',
      'create files',
      'create url aliases',
      'create video content',
      'create webform content',
      'delete all webform submissions',
      'delete any article content',
      'delete any audio files',
      'delete any author_portrait content',
      'delete any ding_page content',
      'delete any document files',
      'delete any faq content',
      'delete any image files',
      'delete any video content',
      'delete any video files',
      'delete any webform content',
      'delete own article content',
      'delete own audio files',
      'delete own author_portrait content',
      'delete own ding_page content',
      'delete own document files',
      'delete own faq content',
      'delete own image files',
      'delete own video content',
      'delete own video files',
      'delete own webform content',
      'delete own webform submissions',
      'delete revisions',
      'delete terms in 8',
      'download any audio files',
      'download any document files',
      'download any image files',
      'download any video files',
      'download own audio files',
      'download own document files',
      'download own image files',
      'download own video files',
      'edit all webform submissions',
      'edit any article content',
      'edit any audio files',
      'edit any author_portrait content',
      'edit any ding_page content',
      'edit any document files',
      'edit any faq content',
      'edit any image files',
      'edit any video content',
      'edit any video files',
      'edit any webform content',
      'edit own article content',
      'edit own audio files',
      'edit own author_portrait content',
      'edit own ding_page content',
      'edit own ding_staff_profile profile',
      'edit own document files',
      'edit own faq content',
      'edit own image files',
      'edit own video content',
      'edit own video files',
      'edit own webform content',
      'edit own webform submissions',
      'edit terms in 8',
      'edit webform components',
      'revert revisions',
      'schedule (un)publishing of nodes',
      'translate admin strings',
      'translate content',
      'translate interface',
      'translate user-defined strings',
      'use text format ding_wysiwyg',
      'view bookmark migration status',
      'view own unpublished content',
      'view revisions',
      'view the administration theme',
    ),
  );

  if (isset($permissions[$role])) {
    return $permissions[$role];
  }
}

/**
 * Implements hook_field_attach_view_alter().
 *
 * Show all abstracts, instead of just the first one.
 */
function reol_base_field_attach_view_alter(&$output, &$context) {
  if (isset($output['ting_abstract'])) {
    $ting_abstract = &$output['ting_abstract'];

    $entity = $ting_abstract['#object'];
    if (isset($entity->reply->record['dcterms:abstract'])) {
      $abstract = $entity->reply->record['dcterms:abstract'][''];
      $ting_abstract[0]['#markup'] = implode('<br /><br />', $abstract);
    }
  }
}

/**
 * Returns ISBN if id is a well fake id.
 *
 * @param string $entity_id
 *   ID to test.
 *
 * @return string|false
 *   ISBN of id, or false if not matching a well fake id.
 */
function reol_base_fake_id($entity_id) {
  if (preg_match('/^publizon:(.*)$/', $entity_id, $matches)) {
    return $matches[1];
  }

  return FALSE;
}

/**
 * Implements hook_field_default_field_instances_alter().
 */
function reol_base_field_default_field_instances_alter(&$fields) {
  // Add settings for our view modes so ding_ting_frontend doesn't show up as
  // overridden.
  $add_modes = array(
    'ting_object-ting_object-ding_availability_holdings' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 18,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 1,
      ),
    ),

    'ting_object-ting_object-ding_entity_buttons' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 12,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 2,
      ),
    ),

    'ting_object-ting_object-ding_periodical_issues' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 16,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 3,
      ),
    ),

    'ting_object-ting_object-ting_abstract' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 11,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 4,
      ),
    ),

    'ting_object-ting_object-ting_author' => array(
      'latest' => array(
        'label' => 'hidden',
        'module' => 'ting',
        'type' => 'ting_author_default',
        'weight' => 1,
      ),
      'review' => array(
        'label' => 'hidden',
        'module' => 'reol_base',
        'type' => 'reol_base_author_plain',
        'weight' => 2,
      ),
    ),

    'ting_object-ting_object-ting_cover' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 13,
      ),
      'review' => array(
        'label' => 'hidden',
        'module' => 'ting_covers',
        'settings' => array(
          'image_style' => 'reol_review',
        ),
        'type' => 'ting_cover_default',
        'weight' => 6,
      ),
    ),

    'ting_object-ting_object-ting_reference_reverse' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 14,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 7,
      ),
    ),

    'ting_object-ting_object-ting_relations' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 15,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 8,
      ),
    ),

    'ting_object-ting_object-ting_series' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 10,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 9,
      ),
    ),

    'ting_object-ting_object-ting_subjects' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 17,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 10,
      ),
    ),

    'ting_object-ting_object-ting_title' => array(
      'latest' => array(
        'label' => 'hidden',
        'module' => 'ting',
        'settings' => array(
          'link_type' => 'none',
          'prefix_type' => 'no',
        ),
        'type' => 'ting_title_default',
        'weight' => 39,
      ),
      'review' => array(
        'label' => 'hidden',
        'module' => 'ting',
        'settings' => array(
          'link_type' => 'none',
          'prefix_type' => 'no',
        ),
        'type' => 'ting_title_default',
        'weight' => 1,
      ),
    ),

    'ting_object-ting_object-ting_type' => array(
      'latest' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 4,
      ),
      'review' => array(
        'label' => 'above',
        'type' => 'hidden',
        'weight' => 12,
      ),
    ),

  );

  foreach ($add_modes as $instance_name => $modes) {
    if (isset($fields[$instance_name])) {
      $fields[$instance_name]['display'] += $modes;
    }
  }

  // Fields defined in ting_material_details.
  $detail_fields = array(
    'age',
    'audience',
    'classification',
    'contributor',
    'description',
    'extent',
    'format',
    'genre',
    'isbn',
    'ispartof',
    'language',
    'musician',
    'pegi',
    'publisher',
    'referenced',
    'replaced_by',
    'replaces',
    'rights',
    'source',
    'spatial',
    'spoken',
    'subjects',
    'subtitles',
    'tracks',
    'type',
    'uri',
    'version',
  );

  // Add our (and the 'compact' added by ting_carousel) display mode to
  // ting_material_details fields, to avoid it being overridden.
  foreach ($detail_fields as $field) {
    if (isset($fields['ting_object-ting_object-ting_details_' . $field])) {
      $fields['ting_object-ting_object-ting_details_' . $field]['display'] += array(
        'compact' => array(
          'label' => 'above',
          'type' => 'hidden',
        ),
        'review' => array(
          'label' => 'above',
          'type' => 'hidden',
        ),
      );
    }
  }

  // Pull relations a bit up in material view.
  if (isset($fields['ting_object-ting_object-ting_relations'])) {
    $fields['ting_object-ting_object-ting_relations']['display']['default']['weight'] = 5;
  }

  // Always link to object rather than collection.
  if (isset($fields['ting_object-ting_object-ting_title'])) {
    $fields['ting_object-ting_object-ting_title']['display']['teaser']['settings']['link_type'] = 'object';
  }

  // Add ting_subjects to search_result view_mode.
  // @see reol_base_field_group_info_alter().
  if (isset($fields['ting_object-ting_object-ting_subjects'])) {
    $fields['ting_object-ting_object-ting_subjects']['display']['search_result']['type'] = 'ting_subjects_default';
    $fields['ting_object-ting_object-ting_subjects']['display']['search_result']['module'] = 'ting';
    $fields['ting_object-ting_object-ting_subjects']['display']['collection_list']['label'] = 'hidden';
    $fields['ting_object-ting_object-ting_subjects']['display']['default']['label'] = 'hidden';
  }

  // Remove subjects from material details.
  if (isset($fields['ting_object-ting_object-ting_details_subjects'])) {
    $fields['ting_object-ting_object-ting_details_subjects']['display']['default']['type'] = 'hidden';
  }

  // Remove description from material details.
  if (isset($fields['ting_object-ting_object-ting_details_description'])) {
    $fields['ting_object-ting_object-ting_details_description']['display']['default']['type'] = 'hidden';
  }

  // Link publisher to a search.
  if (isset($fields['ting_object-ting_object-ting_details_publisher'])) {
    $fields['ting_object-ting_object-ting_details_publisher']['display']['default']['type'] = 'ting_details_generic_search';
    $fields['ting_object-ting_object-ting_details_publisher']['display']['default']['settings'] = array('index' => 'term.publisher');
  }

  // Move audience above genre.
  if (isset($fields['ting_object-ting_object-ting_details_audience'])) {
    $fields['ting_object-ting_object-ting_details_audience']['display']['default']['weigth'] = 65;
  }

  // Compact display mode.
  // Use a formatter that doesn't make the author a link.
  if (isset($fields['ting_object-ting_object-ting_author'])) {
    $fields['ting_object-ting_object-ting_author']['display']['compact']['module'] = 'reol_base';
    $fields['ting_object-ting_object-ting_author']['display']['compact']['type'] = 'reol_base_author_plain';
    $fields['ting_object-ting_object-ting_author']['display']['compact']['label'] = 'hidden';
  }

  // Remove label from cover (the correct image style is set in
  // ereol_frontend/breol_frontend).
  if (isset($fields['ting_object-ting_object-ting_cover'])) {
    $fields['ting_object-ting_object-ting_cover']['display']['compact']['label'] = 'hidden';
  }

  // Remove type prefix.
  if (isset($fields['ting_object-ting_object-ting_title'])) {
    $fields['ting_object-ting_object-ting_title']['display']['default']['settings']['prefix_type'] = 'no';
    $fields['ting_object-ting_object-ting_title']['display']['default']['label'] = 'hidden';
    $fields['ting_object-ting_object-ting_title']['display']['compact']['settings']['prefix_type'] = 'no';
    $fields['ting_object-ting_object-ting_title']['display']['compact']['label'] = 'hidden';
  }

  // Add subjects to teaser view mode.
  if (isset($fields['ting_object-ting_object-ting_details_subjects'])) {
    $fields['ting_object-ting_object-ting_details_subjects']['display']['teaser']['type'] = 'ting_details_subject_search';
    $fields['ting_object-ting_object-ting_details_subjects']['display']['teaser']['module'] = 'ting_material_details';
    $fields['ting_object-ting_object-ting_details_subjects']['display']['teaser']['label'] = 'inline';
    $fields['ting_object-ting_object-ting_details_subjects']['display']['teaser']['label'] = 'hidden';
  }
}

/**
 * Implements hook_field_group_info_alter().
 */
function reol_base_field_group_info_alter(&$groups) {
  if (isset($groups['group_ting_right_col_search|ting_object|ting_object|search_result'])) {
    // Put ting_subjects in the right column in search_result view_mode.
    $groups['group_ting_right_col_search|ting_object|ting_object|search_result']->data['children'][] = 'ting_subjects';
  }

  // Add ebook format, reader name and lix number to material details.
  if (isset($groups['group_material_details|ting_object|ting_object|default'])) {
    $groups['group_material_details|ting_object|ting_object|default']->data['children'][] = 'ting_details_ebook_format';
    $groups['group_material_details|ting_object|ting_object|default']->data['children'][] = 'ting_details_audiobook_reader';
    $groups['group_material_details|ting_object|ting_object|default']->data['children'][] = 'field_lix';
  }

  // Add subjects to teaser view mode - inner group.
  if (isset($groups['group_inner|ting_object|ting_object|teaser'])) {
    $groups['group_inner|ting_object|ting_object|teaser']->data['children'][] = 'ting_details_subjects';
  }

  // Remove rating.
  if (isset($groups['group_rating|ting_object|ting_object|default'])) {
    $groups['group_rating|ting_object|ting_object|default']->data['children'] = array();
  }

  // Remove rating.
  if (isset($groups['group_rating|ting_object|ting_object|search_result'])) {
    $groups['group_rating|ting_object|ting_object|search_result']->data['children'] = array();
  }

  // Remove rating.
  if (isset($groups['group_rating|ting_object|ting_object|teaser'])) {
    $groups['group_rating|ting_object|ting_object|teaser']->data['children'] = array();
  }
}

/**
 * Try to get a ding_entity from a ting object path.
 *
 * Should work for ting/object/<id>.
 */
function _reol_base_object_from_url($url) {
  if (preg_match('{ting/(?:object|collection)/([^#?]*)([#?].*)?$}', $url, $matches)) {
    // The colon could be urlencoded.
    $ting_entity = ding_entity_load(urldecode($matches[1]));

    // ding_entity_load might still return an object for some invalid IDs. Check
    // for the OpenSearch reply to guard against this.
    if (isset($ting_entity->reply)) {
      return $ting_entity;
    }
  }

  return NULL;
}

/**
 * Implements hook_opensearch_pre_execute().
 */
function reol_base_opensearch_pre_execute($request) {
  // Request both dkabm and marcxchange formats for all queries. DKABM data is
  // needed for regular ting object display, and we need to look into MARC data
  // to figure out if this is a quota or free material.
  return array('objectFormat' => array('dkabm', 'marcxchange'));
}

/**
 * Implements hook_opensearch_post_execute().
 *
 * Adds in extra information, not available in DKABM, extracted from MARC data.
 */
function reol_base_opensearch_post_execute($request, $response, $raw_response) {
  if (!is_array($response)) {
    $responses = array($response);
  }
  else {
    $responses = $response;
  }

  $raw_index = -1;
  foreach ($responses as $res) {
    $raw_index++;
    if (is_object($res)) {
      switch (get_class($res)) {
        case 'TingClientObject':
          $res->on_quota = TRUE;
          if (is_array($raw_response->searchResponse->result->searchResult[$raw_index]->collection->object) &&
            isset($raw_response->searchResponse->result->searchResult[$raw_index]->collection->object[0]->collection->record)) {
            _reol_base_odd_marc_data($res, $raw_response->searchResponse->result->searchResult[$raw_index]->collection->object[0]->collection->record);
          }
          break;

        case 'TingClientObjectCollection':
          foreach ($res->objects as $key => $object) {
            $object->on_quota = TRUE;
            if (is_array($raw_response->searchResponse->result->searchResult[0]->collection->object) &&
              isset($raw_response->searchResponse->result->searchResult[0]->collection->object[$key]->collection->record)) {
              _reol_base_odd_marc_data($object, $raw_response->searchResponse->result->searchResult[0]->collection->object[$key]->collection->record);
            }
          }
          break;

        case 'TingClientSearchResult':
          foreach ($res->collections as $col_key => $object_collection) {
            foreach ($object_collection->objects as $key => $object) {
              $object->on_quota = TRUE;
              if (is_array($raw_response->searchResponse->result->searchResult[$col_key]->collection->object) &&
                isset($raw_response->searchResponse->result->searchResult[$col_key]->collection->object[$key]->collection->record)) {
                _reol_base_odd_marc_data($object, $raw_response->searchResponse->result->searchResult[$col_key]->collection->object[$key]->collection->record);
              }
            }
          }
          break;
      }
    }
  }
}

/**
 * Helper to manually add a single translation string.
 *
 * After adding strings use reol_base_locale_clear_cache() for clearing caches.
 */
function reol_base_locale_add_translation($source, $translation, $langcode = 'da', $context = '', $textgroup = 'default') {
  require_once DRUPAL_ROOT . '/includes/locale.inc';

  $report = &drupal_static(__FUNCTION__, array(
    'additions' => 0,
    'updates' => 0,
    'deletes' => 0,
    'skips' => 0,
  ));
  _locale_import_one_string_db($report, $langcode, $context, $source, $translation, $textgroup, 'Manual import via helper ' . __FUNCTION__ . '().', LOCALE_IMPORT_OVERWRITE);
}

/**
 * Helper to clear the locale cache.
 */
function reol_base_locale_clear_cache() {
  require_once DRUPAL_ROOT . '/includes/locale.inc';
  // Clear locale cache.
  _locale_invalidate_js();
  cache_clear_all('locale:', 'cache', TRUE);
}

/**
 * Add extra data from MARC data to the object.
 *
 * @param object $object
 *   Object to add data to, usually a TingClientObject.
 * @param mixed $marc_records
 *   MARC data.
 */
function _reol_base_odd_marc_data($object, $marc_records) {
  $object->on_quota = TRUE;
  $values = _reol_base_get_marc_value($marc_records, '032', 'x');
  if ($values) {
    foreach ($values as $value) {
      // If MARC field 032, subfield x contains an value that starts with "ERA",
      // then the material is not on quota.
      // @see http://www.kat-format.dk/danMARC2/Danmarc2.1e.htm#pgfId=1574593
      // @see http://www.kat-format.dk/danMARC2/Danmarc2.ad.htm#pgfId=1248973
      if (strpos($value, 'ERA') === 0) {
        $object->on_quota = FALSE;
        break;
      }
    }
  }

  $object->lix = NULL;
  $values = _reol_base_get_marc_value($marc_records, '042', 'a');
  if ($values) {
    $object->lix = reset($values);
  }
}

/**
 * Extract a field from MARC data.
 *
 * @param mixed $marc_records
 *   MARC record(s) to extract from.
 * @param string $field
 *   Field to extract (3 digit number).
 * @param string $subfield_name
 *   Subfield to extract, usually one char.
 *
 * @return null|array
 *   Array of values, or null if not found.
 */
function _reol_base_get_marc_value($marc_records, $field, $subfield_name) {
  if (!is_array($marc_records)) {
    $marc_records = array($marc_records);
  }

  $return = array();
  foreach ($marc_records as $marc_record) {
    // Very defensive coding here...
    if (isset($marc_record->{'@type'}->{'$'}) &&
      $marc_record->{'@type'}->{'$'} == 'Bibliographic' &&
      isset($marc_record->datafield)) {
      foreach ($marc_record->datafield as $datafield) {
        if (isset($datafield->{'@tag'}->{'$'}) &&
          $datafield->{'@tag'}->{'$'} == $field &&
          isset($datafield->subfield)) {
          // Subfields is only an array if there's more than one item.
          $subfields = is_array($datafield->subfield) ? $datafield->subfield : array($datafield->subfield);
          foreach ($subfields as $subfield) {
            if (isset($subfield->{'@code'}->{'$'}) &&
              $subfield->{'@code'}->{'$'} == $subfield_name &&
              isset($subfield->{'$'})) {
              $return[] = $subfield->{'$'};
            }
          }
        }
      }
    }
  }

  if (empty($return)) {
    return NULL;
  }
  return $return;
}

/**
 * Validate size of image.
 *
 * @param object $node
 *   The node.
 * @param string $field_name
 *   The field name.
 *
 * @return null|string
 *   Null if size is valid or if the field does not exist. Otherwise an error
 *   message.
 */
function reol_base_validate_image_size($node, $field_name) {
  $wrapper = entity_metadata_wrapper('node', $node);
  if (isset($wrapper->{$field_name})) {
    $value = $wrapper->{$field_name}->value();
    if (isset($value['fid'])) {
      $file = file_load($value['fid']);
      if ($file) {
        $field = field_info_instance('node', $field_name, $node->type);
        $require_exact_dimensions = isset($field['settings']['min_resolution'], $field['settings']['max_resolution'])
          && $field['settings']['min_resolution'] === $field['settings']['max_resolution'];

        if (isset($field['settings']['min_resolution']) && preg_match('/^(?P<width>\d+)x(?P<height>\d+)$/', $field['settings']['min_resolution'], $dimensions)) {
          if ($file->width < $dimensions['width'] || $file->height < $dimensions['height']) {
            return $require_exact_dimensions
              ? t('Image %image must be exactly %widthx%height pixels.', [
                '%image' => $field['label'],
                '%width' => $dimensions['width'],
                '%height' => $dimensions['height'],
              ])
              : t('Image %image must be at least %widthx%height pixels.', [
                '%image' => $field['label'],
                '%width' => $dimensions['width'],
                '%height' => $dimensions['height'],
              ]);
          }
        }
        if (isset($field['settings']['max_resolution']) && preg_match('/^(?P<width>\d+)x(?P<height>\d+)$/', $field['settings']['max_resolution'], $dimensions)) {
          if ($file->width > $dimensions['width'] || $file->height > $dimensions['height']) {
            return $require_exact_dimensions
              ? t('Image %image must be exactly %widthx%height pixels.', [
                '%image' => $field['label'],
                '%width' => $dimensions['width'],
                '%height' => $dimensions['height'],
              ])
              : t('Image %image must be at most %widthx%height pixels.', [
                '%image' => $field['label'],
                '%width' => $dimensions['width'],
                '%height' => $dimensions['height'],
              ]);
          }
        }
      }
    }
  }

  return NULL;
}

/**
 * Get data on series from a ting entity.
 *
 * @param TingEntity $entity
 *   The entity.
 *
 * @return null|array
 *   An array with keys "series" and "number" if part of a series.
 */
function reol_base_get_series_data(TingEntity $entity) {
  $series = $entity->getSeriesTitles();
  if (NULL !== $series) {
    foreach ($series as $item) {
      $item = array_map('trim', $item);
      if (2 === count($item) && !empty($item[0]) && !empty($item[1])) {
        return [
          'series' => $item[0],
          'number' => $item[1],
        ];
      }
    }
  }

  return NULL;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Change the max length of the search input form.
 */
function reol_base_form_search_block_form_alter(&$form, &$form_state, $form_id) {
  $form['search_block_form']['#maxlength'] = 2048;

  // Autocompletion doesn't work as hoped. We disable it.
  unset($form['search_block_form']['#autocomplete_path']);
  // However, a number of scripts expects to the autocomplete JavaScript to be
  // loaded. We load it.
  drupal_add_library('system', 'drupal.autocomplete');
  // Disable browser's built-in autocompletion.
  $form['search_block_form']['#attributes']['autocomplete'] = 'off';
}

/**
 * Implements hook_query_alter().
 *
 * Allow modules to request order by node publication date.
 */
function reol_base_query_alter(QueryAlterableInterface $query) {
  if ($query->hasTag('published_at')) {
    $metadata = $query->getMetaData('published_at');
    if (isset($metadata['order_by']['direction'])) {
      $query->join(
        'publication_date',
        'publication_date',
        'publication_date.nid = node.nid'
      );
      $query->orderBy(
        'publication_date.published_at',
        $metadata['order_by']['direction']
      );
    }
  }
}
